## 苏宁新零售电商离线数据仓库系统项目

### 项目步骤：

### ODS:

#### 一：在mysql里生成数据：

```sql
source /opt/datas/xxx
```

#### 二：hive里ODS层建库建表

**编写ods层的建库建表脚本**

```sql
drop database if exists snbap_ods CASCADE;
-- drop database if exists snbap_dwd CASCADE;
-- drop database if exists snbap_dws CASCADE;
-- drop database if exists snbap_dm CASCADE;
-- hive 建库
create database if not exists snbap_ods;
--create database if not exists snbap_dwd;
--create database if not exists snbap_dws;
--create database if not exists snbap_dm;

use snbap_ods;

CREATE TABLE snbap_ods.ods_biz_trade (
  trade_id bigint     ,
  order_id bigint   ,
  user_id bigint   ,
  amount decimal(18,2)  ,
  trade_type tinyint  ,
  trade_time string  
) 
partitioned by (dt string)
location '/snbap/ods/ods_biz_trade'
 ;


CREATE TABLE snbap_ods.ods_cart (
  cart_id bigint     ,
  session_id string  ,
  user_id bigint   ,
  goods_id bigint   ,
  goods_num int   ,
  add_time string  ,
  cancle_time string  ,
  sumbit_time string  ,
  create_date string
)  
partitioned by (dt string)
location '/snbap/ods/ods_cart'
;



CREATE TABLE snbap_ods.ods_code_category (
  first_category_id int   ,
  first_category_name string  ,
  second_category_id int   ,
  second_catery_name string  ,
  third_category_id int   ,
  third_category_name string  ,
  category_id int     
) 
location '/snbap/ods/ods_code_category'
;



CREATE TABLE snbap_ods.ods_order_delivery (
  order_id bigint   ,
  order_no string  ,
  consignee string  ,
  area_id bigint   ,
  area_name string  ,
  address string  ,
  mobile bigint   ,
  phone string  ,
  coupon_id bigint   ,
  coupon_money decimal(18,2)  ,
  carriage_money decimal(18,2)  ,
  create_time string  ,
  update_time string  ,
  addr_id bigint   
) 
partitioned by (dt string)
location '/snbap/ods/ods_order_delivery'
;



CREATE TABLE snbap_ods.ods_order_item (
  user_id bigint   ,
  order_id bigint   ,
  order_no string  ,
  goods_id bigint   ,
  goods_no string  ,
  goods_name string  ,
  goods_amount int   ,
  shop_id bigint   ,
  shop_name string  ,
  curr_price decimal(18,2)  ,
  market_price decimal(18,2)  ,
  discount decimal(18,2)  ,
  cost_price decimal(18,2)  ,
  first_cart bigint   ,
  first_cart_name string  ,
  second_cart bigint   ,
  second_cart_name string  ,
  third_cart bigint   ,
  third_cart_name string  ,
  goods_desc string  
)  
partitioned by (dt string)
location '/snbap/ods/ods_order_item';



CREATE TABLE snbap_ods.ods_us_order (
  order_id bigint     ,
  order_no string  ,
  order_date string  ,
  user_id bigint   ,
  user_name string  ,
  order_money decimal(18,2)  ,
  order_type int   ,
  order_status int   ,
  pay_status int   ,
  pay_type int   ,
  order_source string  ,
  update_time string  
)
partitioned by (dt string)
location '/snbap/ods/ods_us_order';


CREATE TABLE snbap_ods.ods_user (
  user_id bigint     ,
  user_name string  ,
  user_gender tinyint  ,
  user_birthday string  ,
  user_age int   ,
  constellation string  ,
  province string  ,
  city string  ,
  city_level tinyint  ,
  e_mail string  ,
  op_mail string  ,
  mobile bigint   ,
  num_seg_mobile int   ,
  op_Mobile string  ,
  register_time string  ,
  login_ip string  ,
  login_source string  ,
  request_user string  ,
  total_score decimal(18,2)  ,
  used_score decimal(18,2)  ,
  is_blacklist tinyint  ,
  is_married tinyint  ,
  education string  ,
  monthly_income decimal(18,2) ,
  profession string  ,
  create_date string   
) 
location '/snbap/ods/ods_user';



CREATE TABLE snbap_ods.ods_user_addr (
  user_id bigint   ,
  order_addr string  ,
  user_order_flag tinyint  ,
  addr_id bigint     ,
  arear_id int   
)
location '/snbap/ods/ods_user_addr' ;


CREATE TABLE snbap_ods.ods_user_app_click_log (
  log_id bigint     ,
  user_id bigint   ,
  imei string  ,
  log_time string  ,
  visit_os string  ,
  os_version string  ,
  app_name string  ,
  app_version string  ,
  device_token string  ,
  visit_ip string  ,
  province string  ,
  city string  
) 
partitioned by (dt string)
location '/snbap/ods/ods_user_app_click_log';


CREATE TABLE snbap_ods.ods_user_extend (
  user_id bigint   ,
  user_gender bigint   ,
  is_pregnant_woman tinyint  ,
  is_have_children tinyint  ,
  is_have_car tinyint  ,
  phone_brand string  ,
  phone_brand_level string  ,
  phone_cnt int   ,
  change_phone_cnt int   ,
  is_maja tinyint  ,
  majia_account_cnt int   ,
  loyal_model string  ,
  shopping_type_model string  ,
  weight int   ,
  height int   
)  
location '/snbap/ods/ods_user_extend';


CREATE TABLE snbap_ods.ods_user_pc_click_log (
  log_id bigint     ,
  user_id bigint   ,
  session_id string  ,
  cookie_id string  ,
  visit_time string  ,
  visit_url string  ,
  visit_os string  ,
  browser_name string  ,
  visit_ip string  ,
  province string  ,
  city string  ,
  page_id int   ,
  goods_id bigint   ,
  shop_id bigint   
)
partitioned by (dt string)
location '/snbap/ods/ods_user_pc_click_log'
;


```

#### 三：sqoop从mysql抽取数据到hive

##### 全量导入（能对历史数据进行修改）

> ods_user  ods_user_extend  ods_user_addr  ods_biz_trade

- **脚本一：全量导入（就只有第一次执行）**

```shell
#!bin/bash
sqoop job --delete bap_user1

sqoop job \
--create bap_user1 \
-- import \
--connect jdbc:mysql://192.168.56.101:3306/snbap_ods \
--username root \
--password-file /sqoop/pwd/sqoopPWD.pwd \
--table user \
--delete-target-dir \ # 全量导入要定期删除缓存目录 
--target-dir /snbap/ods/ods_user \ # hiveimport和targetdir选其中一个就可以了
# 全量导入，hdfs上的路径不能存在
--fields-terminated-by '\001'

sqoop job --delete bap_user_extend1

sqoop job \
--create bap_user_extend1 \
-- import \
--connect jdbc:mysql://192.168.56.101:3306/snbap_ods \
--username root \
--password-file /sqoop/pwd/sqoopPWD.pwd \
--table user_extend \
--delete-target-dir \
--target-dir /snbap/ods/ods_user_extend \
--fields-terminated-by '\001'

sqoop job --delete bap_biz_trade1

sqoop job \
--create bap_biz_trade1 \
-- import \
--connect jdbc:mysql://192.168.56.101:3306/snbap_ods \
--username root \
--password-file /sqoop/pwd/sqoopPWD.pwd \
--table biz_trade \
--delete-target-dir \
--target-dir /snbap/ods/ods_biz_trade \
--fields-terminated-by '\001'

sqoop job --delete bap_user_addr1

sqoop job \
--create bap_user_addr1 \
-- import \
--connect jdbc:mysql://192.168.56.101:3306/snbap_ods \
--username root \
--password-file /sqoop/pwd/sqoopPWD.pwd \
--table user_addr \
--delete-target-dir \
--target-dir /snbap/ods/ods_user_addr \
--fields-terminated-by '\001'

sqoop job --exec bap_user1
sqoop job --exec bap_user_addr1
sqoop job --exec bap_biz_trade1
sqoop job --exec bap_user_extend1
```

![image-20200904094700395](C:%5CUsers%5Clenovo%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200904094700395.png)

```shell
sqoop job --exec job名称：
```

- **脚本二：ods的全量导入 和每天都定时脚本**

```shell
crontab -e
分时日月周
02*/1** /root/ods_full_load.sh # 每凌晨2点进行导入

*/10**** /usr/sbin/ntpdate -u poolntp.org >/dev/null 2>&1 # 同步时间

sqoop job --exec bap_user1
sqoop job --exec bap_user_addr1
sqoop job --exec bap_biz_trade1
sqoop job --exec bap_user_extend1
```

##### 增量导入（不能对历史数据进行修改）

> ods_user_pc_click_log  ods_user_app_click_log
>
> ods_user_order  ods_order_item
>
> ods_order_card  ods_order_delivery

```shell
#!bin/bash
# 因为需要分区，先将数据导入hdfs，再另外创建分区表
sqoop job --delete ods_user_pc_click

sqoop job \
--create ods_user_pc_click \
-- import \
--connect jdbc:mysql://192.168.56.101:3306/snbap_ods \
--driver com.mysql.jdbc.Driver \
--username root \
--password-file /sqoop/pwd/sqoopPWD.pwd \
--table user_pc_click_log \
--target-dir /snbap/ods/ods_user_pc_click \
--fields-terminated-by '\001' \
--check-column log_id \
--incremental append \
--last-value 0



sqoop job --delete ods_user_app_click

sqoop job \
--create ods_user_app_click \
-- import \
--connect jdbc:mysql://192.168.56.101:3306/snbap_ods \
--driver com.mysql.jdbc.Driver \
--username root \
--password-file /sqoop/pwd/sqoopPWD.pwd \
--table user_app_click_log \
--target-dir /snbap/ods/ods_user_app_click \
--fields-terminated-by '\001' \
--check-column log_id \
--incremental append \
--last-value 0



sqoop job --delete ods_user_order

sqoop job \
--create ods_user_order \
-- import \
--connect jdbc:mysql://192.168.56.101:3306/snbap_ods \
--driver com.mysql.jdbc.Driver \
--username root \
--password-file /sqoop/pwd/sqoopPWD.pwd \
--table us_order \
--target-dir /snbap/ods/ods_user_order \
--fields-terminated-by '\001' \
--check-column order_id \
--incremental append \
--last-value 0



sqoop job --delete ods_order_item

sqoop job \
--create ods_order_item \
-- import \
--connect jdbc:mysql://192.168.56.101:3306/snbap_ods \
--driver com.mysql.jdbc.Driver \
--username root \
--password-file /sqoop/pwd/sqoopPWD.pwd \
--table order_item \
--target-dir /snbap/ods/ods_order_item \
--fields-terminated-by '\001' \
--check-column order_id \
--incremental append \
--last-value 0



sqoop job --delete ods_order_card

sqoop job \
--create ods_order_card \
-- import \
--connect jdbc:mysql://192.168.56.101:3306/snbap_ods \
--driver com.mysql.jdbc.Driver \
--username root \
--password-file /sqoop/pwd/sqoopPWD.pwd \
--table cart \
--target-dir /snbap/ods/ods_order_card \
--fields-terminated-by '\001' \
--check-column cart_id \
--incremental append \
--last-value 0



sqoop job --delete ods_order_delivery

sqoop job \
--create ods_order_delivery \
-- import \
--connect jdbc:mysql://192.168.56.101:3306/snbap_ods \
--driver com.mysql.jdbc.Driver \
--username root \
--password-file /sqoop/pwd/sqoopPWD.pwd \
--table order_delivery \
--target-dir /snbap/ods/ods_order_delivery \
--fields-terminated-by '\001' \
--check-column order_id \
--incremental append \
--last-value 0


# 执行计划
sqoop job --exec ods_user_pc_click
sqoop job --exec ods_user_app_click_log
sqoop job --exec ods_user_order
sqoop job --exec ods_order_item
sqoop job --exec ods_order_card
sqoop job --exec ods_order_delivery

# 将hdfs的数据导入hive的分区表中
hive --database snbap_ods -e "load data inpath '/snbap/ods/ods_user_pc_click/*' into table snbap_ods.ods_user_pc_click_log partition(dt=20200904)"

hive --database snbap_ods -e "load data inpath '/snbap/ods/ods_user_app_click/*' into table snbap_ods.ods_user_app_click_log partition(dt=20200904)"

hive --database snbap_ods -e "load data inpath '/snbap/ods/ods_user_order/*' into table snbap_ods.ods_us_order  partition(dt=20200904)"

hive --database snbap_ods -e "load data inpath '/snbap/ods/ods_order_item/*' into table snbap_ods.ods_order_item partition(dt=20200904)"

hive --database snbap_ods -e "load data inpath '/snbap/ods/ods_order_card/*' into table snbap_ods.ods_cart partition(dt=20200904)"

hive --database snbap_ods -e "load data inpath '/snbap/ods/ods_order_delivery/*' into table snbap_ods.ods_order_delivery partition(dt=20200904)"
```

- **将导入写成每日定时转移数据到hive表的指定分区的脚本**

```shell
#!bin/bash
#传参添加需要导入的分区，将sqoop导入hdfs的数据导入到分区表的分区中
# 不传参就导1天前的
dt=
if [ $# == 0 ]
then
dt=`date -d "1 day ago" "+%Y%m%d" `
else
dt=$1
fi
hive --database snbap_ods -e "load data inpath '/snbap/ods/ods_user_pc_click/*' into table snbap_ods.ods_user_pc_click_log partition(dt=$dt)"
```

```shell
#!bin/bash
#方法二：sqoop 导入到分区表分区目录下，手动添加分区
hive --database snbap_ods -e "alter table snbap_ods.ods_user_pc_click_log add partition (dt=$dt) location 'snbap/ods/ods_user_pc_click/dt=$dt'"
```

- **运行脚本**

```shell
xx.sh 20200905
```

### DWD:

#### 四：将ods数据进行清洗导入到dwd层，建立对应的指标

> dwd_user_pc_pv dwd_user_app_pv
>
> dwd_user_extend dwd_user_addr
>
> dwd_user  dwd_order 
>
> dwd_delivery  dwd_order_cart 
>
> dwd_order_item

##### DWD层建立事实表和维度表：

```sql
drop database if exists snbap_dwd CASCADE;
-- drop database if exists snbap_dwd CASCADE;
-- drop database if exists snbap_dws CASCADE;
-- drop database if exists snbap_dm CASCADE;
-- hive 建库
create database if not exists snbap_dwd;


use snbap_dwd;

CREATE TABLE snbap_dwd.dwd_biz_trade (
  trade_id bigint     ,
  order_id bigint   ,
  user_id bigint   ,
  amount decimal(18,2)  ,
  trade_type tinyint  ,
  trade_time string  ,
  dw_date string
) 
partitioned by (dt string)
location '/snbap/dwd/dwd_biz_trade'
 ;


CREATE TABLE snbap_dwd.dwd_cart (
  cart_id bigint     ,
  session_id string  ,
  user_id bigint   ,
  godwd_id bigint   ,
  godwd_num int   ,
  add_time string  ,
  cancle_time string  ,
  sumbit_time string  ,
  create_date string,
   dw_date string
)  
partitioned by (dt string)
location '/snbap/dwd/dwd_cart'
;



CREATE TABLE snbap_dwd.dwd_code_category (
  first_category_id int   ,
  first_category_name string  ,
  second_category_id int   ,
  second_catery_name string  ,
  third_category_id int   ,
  third_category_name string  ,
  category_id int     ,
   dw_date string
) 
location '/snbap/dwd/dwd_code_category'
;



CREATE TABLE snbap_dwd.dwd_order_delivery (
  order_id bigint   ,
  order_no string  ,
  consignee string  ,
  area_id bigint   ,
  area_name string  ,
  address string  ,
  mobile bigint   ,
  phone string  ,
  coupon_id bigint   ,
  coupon_money decimal(18,2)  ,
  carriage_money decimal(18,2)  ,
  create_time string  ,
  update_time string  ,
  addr_id bigint   ,
   dw_date string
) 
partitioned by (dt string)
location '/snbap/dwd/dwd_order_delivery'
;



CREATE TABLE snbap_dwd.dwd_order_item (
  user_id bigint   ,
  order_id bigint   ,
  order_no string  ,
  godwd_id bigint   ,
  godwd_no string  ,
  godwd_name string  ,
  godwd_amount int   ,
  shop_id bigint   ,
  shop_name string  ,
  curr_price decimal(18,2)  ,
  market_price decimal(18,2)  ,
  discount decimal(18,2)  ,
  cost_price decimal(18,2)  ,
  first_cart bigint   ,
  first_cart_name string  ,
  second_cart bigint   ,
  second_cart_name string  ,
  third_cart bigint   ,
  third_cart_name string  ,
  godwd_desc string ,
   dw_date string 
)  
partitioned by (dt string)
location '/snbap/dwd/dwd_order_item';



CREATE TABLE snbap_dwd.dwd_us_order (
  order_id bigint     ,
  order_no string  ,
  order_date string  ,
  user_id bigint   ,
  user_name string  ,
  order_money decimal(18,2)  ,
  order_type int   ,
  order_status int   ,
  pay_status int   ,
  pay_type int   ,
  order_source string  ,
  update_time string  ,
   dw_date string
)
partitioned by (dt string)
location '/snbap/dwd/dwd_us_order';


CREATE TABLE snbap_dwd.dwd_user (
  user_id bigint     ,
  user_name string  ,
  user_gender tinyint  ,
  user_birthday string  ,
  user_age int   ,
  constellation string  ,
  province string  ,
  city string  ,
  city_level tinyint  ,
  e_mail string  ,
  op_mail string  ,
  mobile bigint   ,
  num_seg_mobile int   ,
  op_Mobile string  ,
  register_time string  ,
  login_ip string  ,
  login_source string  ,
  request_user string  ,
  total_score decimal(18,2)  ,
  used_score decimal(18,2)  ,
  is_blacklist tinyint  ,
  is_married tinyint  ,
  education string  ,
  monthly_income decimal(18,2) ,
  profession string  ,
  dw_date string   
) 
location '/snbap/dwd/dwd_user';



CREATE TABLE snbap_dwd.dwd_user_addr (
  user_id bigint   ,
  order_addr string  ,
  user_order_flag tinyint  ,
  addr_id bigint     ,
  arear_id int   ,
   dw_date string
)
location '/snbap/dwd/dwd_user_addr' ;


CREATE TABLE snbap_dwd.dwd_user_extend (
  user_id bigint   ,
  user_gender bigint   ,
  is_pregnant_woman tinyint  ,
  is_have_children tinyint  ,
  is_have_car tinyint  ,
  phone_brand string  ,
  phone_brand_level string  ,
  phone_cnt int   ,
  change_phone_cnt int   ,
  is_maja tinyint  ,
  majia_account_cnt int   ,
  loyal_model string  ,
  shopping_type_model string  ,
  weight int   ,
  height int   ,
   dw_date string
)  
location '/snbap/dwd/dwd_user_extend';




CREATE external TABLE snbap_dwd.dwd_user_app_pv (
  log_id bigint     ,
  user_id bigint   ,
  imei string  ,
  log_time string  ,
  log_hour string,
  visit_os string  ,
  os_version string  ,
  app_name string  ,
  app_version string  ,
  device_token string  ,
  visit_ip string  ,
  province string  ,
  city string  ,
  dw_date string
) 
partitioned by (dt string)
location '/snbap/dwd/dwd_user_app_pv'
;



CREATE TABLE snbap_dwd.dwd_user_pc_pv (
  log_id bigint     ,
  user_id bigint   ,
  session_id string  ,
  cookie_id string  ,
  in_time string,
  out_time string,
  stay_time bigint,
  pv bigint,
  visit_os string  ,
  browser_name string  ,
  visit_ip string  ,
  province string  ,
  city string  ,
  dw_date string
)
partitioned by (dt string)
location '/snbap/dwd/dwd_user_pc_pv'
;
```



##### DWD事实表插入数据:

- **dwd_user**

```sql
--加载访问user表 
insert overwrite table snbap_dwd.dwd_user
select
user_id,
user_name ,
user_gender,
user_birthday,
user_age,
constellation,
province,
city, 
city_level,
e_mail ,
op_mail,
mobile ,
num_seg_mobile,
op_mobile ,
register_time,
login_ip, 
login_source,
request_user,
total_score,
used_score,
is_blacklist,
is_married,
education ,
monthly_income, 
profession,
current_timestamp() dw_date
from snbap_ods.ods_user
```



- **dwd_us_rder**

```sql

```



##### DWD维度表插入数据:

- **dwd_user_pc_pv** 

```sql
-- 加载访问pc表
insert into table snbap_dwd.dwd_user_pc_pv partition(dt=20200904)
select
max(log_id),
user_id,
session_id,
cookie_id, 
min(visit_time)  in_time,
max(visit_time) out_time, 
unix_timestamp(max(visit_time)) - unix_timestamp(min(visit_time)) stay_time, 
count(1) pv, 
visit_os, 
browser_ring, 
visit_ip,
province, 
city, 
current_timestamp() dw_date
from
snbap_ods.ods_user_pc_click_log
where dt='20200904'
group by
user_id,
session_id,
cookie_id,
visit_os,
browser_name,
visit_ip,
province,
city
```



- **dwd_user_app_pv**

```sql
insert into table snbap_dwd.dwd_user_app_pv partition(dt=20200904)
select log_id,
user_id,
imei,
log_time,
hour(log_time) log_hour,
visit_os,os_version,
app_name,
app_version,
device_token,
visit_ip,
province,city,
current_timestamp() dw_date
from
snbap_ods.ods_user_app_click_log
where dt='20200904'
```



- **dwd_user_extend** 

```sql
insert overwrite table snbap_dwd.dwd_user_extend
select
user_id,
user_gender,
is_pregnant_woman,
is_have_children,
is_have_car,
phone_brand,
phone_brand_level,
phone_cnt,
change_phone_cnt,
is_maja,
majia_account_cnt,
loyal_model,
shopping_type_model,
weight,
height,
current_timestamp() dw_date
from snbap_ods.ods_user_extend
```



- **dwd_user_addr**

```sql
insert overwrite table snbap_dwd.dwd_user_addr
select
user_id,
order_addr,
user_order_flag,
addr_id,
arear_id,
current_timestamp() dw_date
from snbap_ods.ods_user_addr
```



- **dwd_order_delivery**

```sql
insert into table snbap_dwd.dwd_order_delivery partition(dt=20200904)
select
order_id,
order_no,
consignee,
area_id,
area_name,
address,
mobile,
phone,
coupon_id,
coupon_money,
carriage_money,
create_time,
update_time,
addr_id,
current_timestamp() dw_date
from
snbap_ods.ods_order_delivery
where dt='20200904'
```



- **dwd_order_cart** 

```sql
insert into table snbap_dwd.dwd_cart partition(dt=20200904)
select
cart_id,
session_id,
user_id,
goods_id,
goods_num,
add_time,
cancle_time,
sumbit_time,
create_date,
current_timestamp() dw_date
from
snbap_ods.ods_cart
where dt='20200904'
```

- **dwd_order_item**

```sql
insert into table snbap_dwd.dwd_order_item partition(dt=20200904)
select
user_id,
order_id,
order_no,
goods_id,
goods_no,
goods_name,
goods_amount,
shop_id,
shop_name,
curr_price,
market_price,
discount,
cost_price,
first_cart,
first_cart_name,
second_cart,
second_cart_name,
third_cart,
third_cart_name,
goods_desc,
current_timestamp() dw_date
from
snbap_ods.ods_order_item
where dt='20200904'
```

### DWS:

#### 五：DWD层进行轻度聚合汇总到DWS层

##### DWS建库建表：

```sql
create database snbap_dws;
drop table if exists snbap_dws.dws_user_visit_month1;
create table if not exists snbap_dws.dws_user_visit_month1
(
   user_id              bigint ,
   type                 string,
   content              string,
   cnt                  bigint,
   rn                   bigint,
   dw_date              string
)
partitioned by (dt string)
stored as orc
location '/snbap/dws/dws_user_visit_month1'
;


drop table if exists snbap_dws.dws_user_basic;
create table if not exists snbap_dws.dws_user_basic
(
  `user_id` bigint, 
  `user_name` string, 
  `user_gender` tinyint, 
  `user_birthday` string, 
  `user_age` int, 
  `constellation` string, 
  `province` string, 
  `city` string, 
  `city_level` tinyint, 
  `e_mail` string, 
  `op_mail` string, 
  `mobile` bigint, 
  `num_seg_mobile` int, 
  `op_mobile` string, 
  `register_time` string, 
  `login_ip` string, 
  `login_source` string, 
  `request_user` string, 
  `total_score` decimal(18,2), 
  `used_score` decimal(18,2), 
  `is_blacklist` tinyint, 
  `is_married` tinyint, 
  `education` string, 
  `monthly_income` decimal(18,2), 
  `profession` string, 
  `is_pregnant_woman` tinyint, 
  `is_have_children` tinyint, 
  `is_have_car` tinyint, 
  `phone_brand` string, 
  `phone_brand_level` string, 
  `phone_cnt` int, 
  `change_phone_cnt` int, 
  `is_maja` tinyint, 
  `majia_account_cnt` int, 
  `loyal_model` string, 
  `shopping_type_model` string, 
  `weight` int, 
  `height` int
)
stored as orc
location '/snbap/dws/dws_user_basic'
;
```



##### DWS插入数据：

```sql
insert into table snbap_dws.dws_user_basic 
select * 
from 
(
select 
  u.`user_id` , 
  u.`user_name` , 
  u.`user_gender` , 
  u.`user_birthday` , 
  u.`user_age` , 
  u.`constellation` , 
  u.`province` , 
  u.`city` , 
  u.`city_level` , 
  u.`e_mail` , 
  u.`op_mail` , 
  u.`mobile` , 
  u.`num_seg_mobile` , 
  u.`op_mobile` , 
  u.`register_time` , 
  u.`login_ip` , 
  u.`login_source` , 
  u.`request_user` , 
  u.`total_score` , 
  u.`used_score` , 
  u.`is_blacklist` , 
  u.`is_married` , 
  u.`education` , 
  u.`monthly_income` , 
  u.`profession` , 
  ue.`is_pregnant_woman` , 
  ue.`is_have_children` , 
  ue.`is_have_car` , 
  ue.`phone_brand` , 
  ue.`phone_brand_level` , 
  ue.`phone_cnt` , 
  ue.`change_phone_cnt` , 
  ue.`is_maja` , 
  ue.`majia_account_cnt` , 
  ue.`loyal_model` , 
  ue.`shopping_type_model` , 
  ue.`weight` , 
  ue.`height` 
from 
snbap_dwd.dwd_user u 
join snbap_dwd.dwd_user_extend ue on u.user_id=ue.user_id 
) t;
```





```sql
insert into table snbap_dws.dws_user_visit_month1 partition(dt=20200904)
select 
tmp.user_id,
tmp.`type`,
tmp.content,
tmp.cnt,
row_number() over(distribute by tmp.user_id,tmp.`type` sort by tmp.cnt desc) rn,
current_timestamp() `dw_date`
from
(
select
user_id,
'visit_ip' `type`,
visit_ip content,
sum(pv) cnt
from snbap_dwd.dwd_user_pc_pv
where in_time <= '2020-09-04' and datediff('2020-09-04',date(in_time)) < 30
group by 
user_id,
visit_ip

union all

select
user_id,
'cookie_id' `type`,
cookie_id content,
sum(pv) cnt
from snbap_dwd.dwd_user_pc_pv
where in_time <= '2020-09-04' and  datediff('2020-09-04',date(in_time)) < 30
group by 
user_id,
cookie_id

union all
    
select
user_id,
'browser_name' `type`,
browser_name content,
sum(pv) cnt
from snbap_dwd.dwd_user_pc_pv
where in_time <= '2020-09-04' and  datediff('2020-09-04',date(in_time)) < 30
group by 
user_id,
browser_name

union all

select
user_id,
'visit_os' `type`,
visit_os content,
sum(pv) cnt
from snbap_dwd.dwd_user_pc_pv
where date(in_time) <= '2020-09-04' and  datediff('2020-09-04',date(in_time)) < 30
group by 
user_id,
visit_os
) tmp

limit 20
```

### ADS/DM:

#### 六：DWS层提取数据做成大宽表汇总到ADS层

##### ADS建库建表：

```sql

```



##### ADS插入数据：

###### 所需app端数据指标：



![image-20200908091212435](C:%5CUsers%5Clenovo%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200908091212435.png)

- **最近一次**
- **第一次**
- **近7天，30天，60天，90天**

```sql
%hive
select
app.user_id,
max(case when drn = 1 then app.log_time end) lastest_app_visit_time, -- 最近一次访问时间
max(case when drn = 1 then app.app_name end) lastest_app_time, -- 最近一次访问app名称
max(case when drn = 1 then app.visit_os end) lastest_app_visit_os, -- 最近一次访问app操作系统
max(case when rn = 1 then app.log_time end) first_app_visit_time, -- 最近一次访问时间
max(case when rn = 1 then app.app_name end) first_app_time, -- 最近一次访问app名称
max(case when rn = 1 then app.visit_os end) first_app_visit_os, -- 最近一次访问app操作系统
max(case when rn = 1 then app.visit_ip end) first_app_visit_ip, -- 最近一次访问app操作系统ip
sum(app_dt7) day7_app_cnt,
sum(app_dt15) day15_app_cnt,
sum(app_dt30) day30_app_cnt,
sum(app_dt60) day60_app_cnt,
sum(app_dt90) day90_app_cnt,
sum(case when app_dt30 = 1 and app_hr_025 = 1 then 1 end) month1_app_hour025_cnt,
sum(case when app_dt30 = 1 and app_hr_627 = 1 then 1 end) month1_app_hour627_cnt,
sum(case when app_dt30 = 1 and app_hr_829 = 1 then 1 end) month1_app_hour829_cnt,
sum(case when app_dt30 = 1 and app_hr_10211 = 1 then 1 end) month1_app_hour10211_cnt,
sum(case when app_dt30 = 1 and app_hr_12213 = 1 then 1 end) month1_app_hour12213_cnt,
sum(case when app_dt30 = 1 and app_hr_14215 = 1 then 1 end) month1_app_hour14215_cnt,
sum(case when app_dt30 = 1 and app_hr_16217 = 1 then 1 end) month1_app_hour16217_cnt,
sum(case when app_dt30 = 1 and app_hr_18219 = 1 then 1 end) month1_app_hour18219_cnt,
sum(case when app_dt30 = 1 and app_hr_20221 = 1 then 1 end) month1_app_hour20221_cnt,
sum(case when app_dt30 = 1 and app_hr_22223 = 1 then 1 end) month1_app_hour22223_cnt
from
(
select
user_id,
imei,
log_time,
log_hour,
visit_os,
os_version,
app_name,
app_version,
device_token,
visit_ip,
province,
city,
row_number() over(distribute by user_id sort by log_time asc) rn,
row_number() over(distribute by user_id sort by log_time desc) drn,
case when log_time >= date_sub('2020-08-10', 6) then 1 end app_dt7,
case when log_time >= date_sub('2020-08-10', 14) then 1 end app_dt15,
case when log_time >= date_sub('2020-08-10', 29) then 1 end app_dt30,
case when log_time >= date_sub('2020-08-10', 59) then 1 end app_dt60,
case when log_time >= date_sub('2020-08-10', 89) then 1 end app_dt90,
case when hour(log_time) between 0 and 5 then 1 end app_hr_025,
case when hour(log_time) between 6 and 7 then 1 end app_hr_627,
case when hour(log_time) between 8 and 9 then 1 end app_hr_829,
case when hour(log_time) between 10 and 11 then 1 end app_hr_10211,
case when hour(log_time) between 12 and 13 then 1 end app_hr_12213,
case when hour(log_time) between 14 and 15 then 1 end app_hr_14215,
case when hour(log_time) between 16 and 17 then 1 end app_hr_16217,
case when hour(log_time) between 18 and 19 then 1 end app_hr_18219,
case when hour(log_time) between 20 and 21 then 1 end app_hr_20221,
case when hour(log_time) between 22 and 23 then 1 end app_hr_22223
from snbap_dwd.dwd_user_app_pv
) app
group by app.user_id
;

```







###### 所需pc端数据指标：



![image-20200908091110958](C:%5CUsers%5Clenovo%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200908091110958.png)

![image-20200908091132027](C:%5CUsers%5Clenovo%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200908091132027.png)

- **最近一次**
- **第一次**
- **近7天，30天，60天，90天**

```sql
select
pc.user_id,
max(case when pc.drn=1 then pc.in_time end) latest_pc_visit_date,
max(case when pc.drn=1 then pc.session_id end)  latest_pc_visit_session,
max(case when pc.drn=1 then pc.cookie_id end)  latest_pc_cookies,
max(case when pc.drn=1 then pc.pv end)  latest_pc_pv,
max(case when pc.drn=1 then pc.browser_name end)  latest_pc_visit_browser_name,
max(case when pc.drn=1 then pc.visit_os end)  latest_pc_visit_os,
max(case when pc.rn=1 then pc.in_time end)  first_pc_visit_date,
max(case when pc.rn=1 then pc.session_id end)  first_pc_visit_session,
max(case when pc.rn=1 then pc.cookie_id end)  first_pc_cookies,
max(case when pc.rn=1 then pc.pv end)  first_pc_pv,
max(case when pc.rn=1 then pc.browser_name end)  first_pc_visit_browser_name,
max(case when pc.rn=1 then pc.visit_os end)  first_pc_visit_os,
sum(pc.dt7) day7_pc_cnt,
sum(pc.dt15) day15_pc_cnt,
sum(pc.dt30) month1_pc_cnt,
sum(pc.dt60) month2_pc_cnt,
sum(pc.dt90) month3_pc_cnt,
sum(case when pc.dt30=1 then pc.pv end) month1_pc_pv,
sum(case when pc.dt30=1 then pc.pv end)/sum(pc.dt30) month1_pc_avg_pv,
sum(case when pc.dt30=1 and pc.hr025=1 then pc.pv end) month1_pc_hour025_cnt,
sum(case when pc.dt30=1 and pc.hr627=1 then pc.pv end) month1_pc_hour627_cnt,
sum(case when pc.dt30=1 and pc.hr829=1 then pc.pv end) month1_pc_hour829_cnt,
sum(case when pc.dt30=1 and pc.hr10211=1 then pc.pv end) month1_pc_hour10211_cnt,
sum(case when pc.dt30=1 and pc.hr12213=1 then pc.pv end) month1_pc_hour12213_cnt,
sum(case when pc.dt30=1 and pc.hr14215=1 then pc.pv end) month1_pc_hour14215_cnt,
sum(case when pc.dt30=1 and pc.hr16217=1 then pc.pv end) month1_pc_hour16217_cnt,
sum(case when pc.dt30=1 and pc.hr18219=1 then pc.pv end) month1_pc_hour18219_cnt,
sum(case when pc.dt30=1 and pc.hr20221=1 then pc.pv end) month1_pc_hour20221_cnt,
sum(case when pc.dt30=1 and pc.hr22223=1 then pc.pv end) month1_pc_hour22223_cnt,
count(case when type='visit_ip' then content end ) month1_pc_diff_ip_cnt,
max(case when m1.rn=1 and type='visit_ip' then content end) month1_pc_common_ip_cnt,
count(case when type='cookie_id' then content end ) month1_pc_diff_cookie_cnt,
max(case when m1.rn=1 and type='cookie_id' then content end) month1_pc_common_cookie_cnt,
max(case when type='browser_name' then content end ) month1_pc_common_browser_name,
max(case when m1.rn=1 and type='visit_os' then content end) month1_pc_common_os
from 
(
select 
user_id, 
session_id, 
cookie_id, 
in_time, 
out_time, 
stay_time, 
pv, 
visit_os, 
browser_name, 
visit_ip, 
province, 
city,
row_number() over(distribute by user_id sort by in_time asc) rn,
row_number() over(distribute by user_id sort by in_time desc) drn,
case when in_time>=date_sub('2020-08-10',6) then 1 end dt7,
case when in_time>=date_sub('2020-08-10',14) then 1 end dt15,
case when in_time>=date_sub('2020-08-10',29) then 1 end dt30,
case when in_time>=date_sub('2020-08-10',59) then 1 end dt60,
case when in_time>=date_sub('2020-08-10',89) then 1 end dt90,
case when hour(in_time) between 0 and 5 then 1 end hr025,
case when hour(in_time) between 6 and 7  then 1 end hr627 ,
case when hour(in_time) between 8 and 9  then 1 end hr829 ,
case when hour(in_time) between 10 and 11 then 1 end hr10211,
case when hour(in_time) between 12 and 13 then 1 end hr12213,
case when hour(in_time) between 14 and 15 then 1 end hr14215,
case when hour(in_time) between 16 and 17 then 1 end hr16217,
case when hour(in_time) between 18 and 19 then 1 end hr18219,
case when hour(in_time) between 20 and 21 then 1 end hr20221,
case when hour(in_time) between 22 and 23 then 1 end hr22223
from snbap_dwd.dwd_user_pc_pv
) pc
join snbap_dws.dws_user_visit_month1 m1
on pc.user_id=m1.user_id
group by pc.user_id
;
```

###### 近30天pc指标：

![image-20200908091016439](C:%5CUsers%5Clenovo%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200908091016439.png)

```sql
-- 30天内的指标
select
user_id,
count(case when type='visit_ip' then content end ) month1_pc_diff_ip_cnt,
max(case when rn=1 and type='visit_ip' then content end) month1_pc_common_ip_cnt,
count(case when type='cookie_id' then content end ) month1_pc_diff_cookie_cnt,
max(case when rn=1 and type='cookie_id' then content end) month1_pc_common_cookie_cnt,
max(case when type='browser_name' then content end ) month1_pc_common_browser_name,
max(case when rn=1 and type='visit_os' then content end) month1_pc_common_os
from snbap_dws.dws_user_visit_month1
group by user_id
```

###### 综合指标：

###### 全部指标：

```sql
select 
ub.user_id,
t_pc.latest_pc_visit_date,-- 最近一次访问日期
t_pc.latest_pc_visit_session,-- 最近一次访问session_id
t_pc.latest_pc_cookies,-- 最近一次访问cookie_id
t_pc.latest_pc_pv,-- 最近一次访问pv数量
t_pc.latest_pc_visit_browser_name,-- 最近一次访问browser_name
t_pc.latest_pc_visit_os,-- 最近一次访问visit_os
t_pc.first_pc_visit_date,-- 第一次一次访问日期
t_pc.first_pc_visit_session,-- 第一次一次访问session_id
t_pc.first_pc_cookies,-- 第一次一次访问cookie_id
t_pc.first_pc_pv, -- 第一次一次访问pv数量
t_pc.first_pc_visit_browser_name,-- 第一次一次访问browser_name
t_pc.first_pc_visit_os,-- 第一次一次访问visit_os
t_pc.day7_pc_cnt,-- 近7天访问次数
t_pc.day15_pc_cnt, -- 近15天访问次数 
t_pc.month1_pc_cnt, -- 近30天访问次数
t_pc.month2_pc_cnt, -- 近60天访问次数
t_pc.month3_pc_cnt, -- 近90天访问次数
t_pc.month1_pc_pv, -- 近30天pc端pv
t_pc.month1_pc_avg_pv, -- 近30天pc端平均pv
t_pc.month1_pc_hour025_cnt,-- 近30天pc端访问0到5点pv数
t_pc.month1_pc_hour627_cnt,-- 近30天pc端访问6 到7 点pv数
t_pc.month1_pc_hour829_cnt,-- 近30天pc端访问8 到9 点pv数
t_pc.month1_pc_hour10211_cnt,-- 近30天pc端访问10到11点pv数
t_pc.month1_pc_hour12213_cnt,-- 近30天pc端访问12到13点pv数
t_pc.month1_pc_hour14215_cnt,-- 近30天pc端访问14到15点pv数
t_pc.month1_pc_hour16217_cnt,-- 近30天pc端访问16到17点pv数
t_pc.month1_pc_hour18219_cnt,-- 近30天pc端访问18到19点pv数
t_pc.month1_pc_hour20221_cnt,-- 近30天pc端访问20到21点pv数
t_pc.month1_pc_hour22223_cnt, -- 近30天pc端访问22到23点pv数

t_month1.month1_pc_diff_ip_cnt, -- 30天内使用的不同ip数量
t_month1.month1_pc_common_ip_cnt,  -- 30天内常用ip
t_month1.month1_pc_diff_cookie_cnt, -- 30天内使用的不同cookie数量
t_month1.month1_pc_common_cookie_cnt, -- 30天内常用cookie
t_month1.month1_pc_common_browser_name, -- 30天内常用browser
t_month1.month1_pc_common_os, -- 30天内常用操作系统

t_app.latest_app_visit_time,-- 最近一次访问的时间
t_app.latest_app_name,-- 最近一次访问的APP名称
t_app.latest_app_visit_os,-- 最近一次访问的APP操作系统
t_app.first_app_visit_time,-- 第一次访问的时间
t_app.first_app_name,-- 第一次访问的APP名称
t_app.first_app_visit_os,-- 第一次访问的APP操作系统
t_app.first_app_visit_ip,-- 第一次访问的ip
t_app.day7_app_cnt, -- app端近7天访问次数
t_app.day15_app_cnt, -- app端近15天访问次数
t_app.day30_app_cnt, -- app端近30天访问次数
t_app.day60_app_cnt, -- app端近60天访问次数
t_app.day90_app_cnt, -- app端近90天访问次数
t_app.month1_app_hour025_cnt, -- 近30天app端访问0到5点访问数
t_app.month1_app_hour627_cnt, -- 近30天app端访问6到7点访问数
t_app.month1_app_hour829_cnt, -- 近30天app端访问8到9点访问数
t_app.month1_app_hour10211_cnt, -- 近30天app端访问10到11点访问数
t_app.month1_app_hour12213_cnt, -- 近30天app端访问12到13点访问数
t_app.month1_app_hour14215_cnt, -- 近30天app端访问14到15点访问数
t_app.month1_app_hour16217_cnt, -- 近30天app端访问16到17点访问数
t_app.month1_app_hour18219_cnt, -- 近30天app端访问18到19点访问数
t_app.month1_app_hour20221_cnt, -- 近30天app端访问20到21点访问数
t_app.month1_app_hour22223_cnt -- 近30天app端访问22到23点访问数

from 
snbap_dws.dws_user_basic ub 
join 
(
-- pc端指标
select 
pc.user_id,
max(case when pc.drn=1 then pc.in_time end)  latest_pc_visit_date,-- 最近一次访问日期
max(case when pc.drn=1 then pc.session_id end)  latest_pc_visit_session,-- 最近一次访问session_id
max(case when pc.drn=1 then pc.cookie_id end)  latest_pc_cookies,-- 最近一次访问cookie_id
max(case when pc.drn=1 then pc.pv end)  latest_pc_pv,-- 最近一次访问pv数量
max(case when pc.drn=1 then pc.browser_name end)  latest_pc_visit_browser_name,-- 最近一次访问browser_name
max(case when pc.drn=1 then pc.visit_os end)  latest_pc_visit_os,-- 最近一次访问visit_os
max(case when pc.rn=1 then pc.in_time end)  first_pc_visit_date,-- 第一次一次访问日期
max(case when pc.rn=1 then pc.session_id end)  first_pc_visit_session,-- 第一次一次访问session_id
max(case when pc.rn=1 then pc.cookie_id end)  first_pc_cookies,-- 第一次一次访问cookie_id
max(case when pc.rn=1 then pc.pv end)  first_pc_pv, -- 第一次一次访问pv数量
max(case when pc.rn=1 then pc.browser_name end)  first_pc_visit_browser_name,-- 第一次一次访问browser_name
max(case when pc.rn=1 then pc.visit_os end)  first_pc_visit_os,-- 第一次一次访问visit_os
sum(pc.dt7) day7_pc_cnt,-- 近7天访问次数
sum(pc.dt15) day15_pc_cnt, -- 近15天访问次数 
sum(pc.dt30) month1_pc_cnt, -- 近30天访问次数
sum(pc.dt60) month2_pc_cnt, -- 近60天访问次数
sum(pc.dt90) month3_pc_cnt, -- 近90天访问次数
sum(case when pc.dt30=1 then pc.pv end ) month1_pc_pv, -- 近30天pc端pv
sum(case when pc.dt30=1 then pc.pv end )/sum(pc.dt30)  month1_pc_avg_pv, -- 近30天pc端平均pv
sum(case when pc.dt30=1 and pc.hr025=1 then pc.pv end) month1_pc_hour025_cnt,     -- 近30天pc端访问0到5点pv数
sum(case when pc.dt30=1 and pc.hr627=1 then pc.pv end) month1_pc_hour627_cnt,     -- 近30天pc端访问6 到7 点pv数
sum(case when pc.dt30=1 and pc.hr829 =1 then pc.pv end) month1_pc_hour829_cnt,    -- 近30天pc端访问8 到9 点pv数
sum(case when pc.dt30=1 and pc.hr10211=1 then pc.pv end) month1_pc_hour10211_cnt, -- 近30天pc端访问10到11点pv数
sum(case when pc.dt30=1 and pc.hr12213=1 then pc.pv end) month1_pc_hour12213_cnt, -- 近30天pc端访问12到13点pv数
sum(case when pc.dt30=1 and pc.hr14215=1 then pc.pv end) month1_pc_hour14215_cnt, -- 近30天pc端访问14到15点pv数
sum(case when pc.dt30=1 and pc.hr16217=1 then pc.pv end) month1_pc_hour16217_cnt, -- 近30天pc端访问16到17点pv数
sum(case when pc.dt30=1 and pc.hr18219=1 then pc.pv end) month1_pc_hour18219_cnt, -- 近30天pc端访问18到19点pv数
sum(case when pc.dt30=1 and pc.hr20221=1 then pc.pv end) month1_pc_hour20221_cnt, -- 近30天pc端访问20到21点pv数
sum(case when pc.dt30=1 and pc.hr22223=1 then pc.pv end) month1_pc_hour22223_cnt  -- 近30天pc端访问22到23点pv数
from 
(
select 
user_id, 
session_id, 
cookie_id, 
in_time, 
out_time, 
stay_time, 
pv, 
visit_os, 
browser_name, 
visit_ip, 
province, 
city,
row_number() over(distribute by user_id sort by in_time asc) rn,
row_number() over(distribute by user_id sort by in_time desc) drn,
case when in_time>=date_sub('2020-08-10',6) then 1 end dt7,
case when in_time>=date_sub('2020-08-10',14) then 1 end dt15,
case when in_time>=date_sub('2020-08-10',29) then 1 end dt30,
case when in_time>=date_sub('2020-08-10',59) then 1 end dt60,
case when in_time>=date_sub('2020-08-10',89) then 1 end dt90,
case when hour(in_time) between 0 and 5 then 1 end hr025,
case when hour(in_time) between 6 and 7  then 1 end hr627 ,
case when hour(in_time) between 8 and 9  then 1 end hr829 ,
case when hour(in_time) between 10 and 11 then 1 end hr10211,
case when hour(in_time) between 12 and 13 then 1 end hr12213,
case when hour(in_time) between 14 and 15 then 1 end hr14215,
case when hour(in_time) between 16 and 17 then 1 end hr16217,
case when hour(in_time) between 18 and 19 then 1 end hr18219,
case when hour(in_time) between 20 and 21 then 1 end hr20221,
case when hour(in_time) between 22 and 23 then 1 end hr22223
from snbap_dwd.dwd_user_pc_pv
) pc
group by pc.user_id
) t_pc on ub.user_id=t_pc.user_id

join 
(
select
user_id,
count(case when type='visit_ip' then content end ) month1_pc_diff_ip_cnt,
max(case when rn=1 and type='visit_ip' then content end) month1_pc_common_ip_cnt,
count(case when type='cookie_id' then content end ) month1_pc_diff_cookie_cnt,
max(case when rn=1 and type='cookie_id' then content end) month1_pc_common_cookie_cnt,
max(case when type='browser_name' then content end ) month1_pc_common_browser_name,
max(case when rn=1 and type='visit_os' then content end) month1_pc_common_os
from snbap_dws.dws_user_visit_month1
group by user_id
) t_month1 on t_month1.user_id=ub.user_id

join 
(
-- APP端指标
select
app.user_id,
max(case when drn=1 then app.log_time end) latest_app_visit_time,-- 最近一次访问的时间
max(case when drn=1 then app.app_name end) latest_app_name,-- 最近一次访问的APP名称
max(case when drn=1 then app.visit_os end) latest_app_visit_os,-- 最近一次访问的APP操作系统
max(case when rn=1 then app.log_time end) first_app_visit_time,-- 第一次访问的时间
max(case when rn=1 then app.app_name end) first_app_name,-- 第一次访问的APP名称
max(case when rn=1 then app.visit_os end) first_app_visit_os,-- 第一次访问的APP操作系统
max(case when rn=1 then app.visit_ip end) first_app_visit_ip,-- 第一次访问的ip
sum(app_dt7) day7_app_cnt,
sum(app_dt15) day15_app_cnt,
sum(app_dt30) day30_app_cnt,
sum(app_dt60) day60_app_cnt,
sum(app_dt90) day90_app_cnt,
sum(case when app_dt30=1 and app_hr_025=1 then 1 end) month1_app_hour025_cnt,
sum(case when app_dt30=1 and app_hr_627=1 then 1 end) month1_app_hour627_cnt,
sum(case when app_dt30=1 and app_hr_829=1 then 1 end) month1_app_hour829_cnt,
sum(case when app_dt30=1 and app_hr_10211=1 then 1 end) month1_app_hour10211_cnt,
sum(case when app_dt30=1 and app_hr_12213=1 then 1 end) month1_app_hour12213_cnt,
sum(case when app_dt30=1 and app_hr_14215=1 then 1 end) month1_app_hour14215_cnt,
sum(case when app_dt30=1 and app_hr_16217=1 then 1 end) month1_app_hour16217_cnt,
sum(case when app_dt30=1 and app_hr_18219=1 then 1 end) month1_app_hour18219_cnt,
sum(case when app_dt30=1 and app_hr_20221=1 then 1 end) month1_app_hour20221_cnt,
sum(case when app_dt30=1 and app_hr_22223=1 then 1 end) month1_app_hour22223_cnt
from 
(
select 
user_id,
imei,
log_time,
log_hour,
visit_os,
os_version,
app_name,
app_version,
device_token,
visit_ip,
province,
city,
row_number() over(distribute by user_id sort by log_time asc) rn,
row_number() over(distribute by user_id sort by log_time desc) drn,
case when log_time>=date_sub('2020-08-10',6) then 1 end app_dt7,
case when log_time>=date_sub('2020-08-10',14) then 1 end app_dt15,
case when log_time>=date_sub('2020-08-10',29) then 1 end app_dt30,
case when log_time>=date_sub('2020-08-10',59) then 1 end app_dt60,
case when log_time>=date_sub('2020-08-10',89) then 1 end app_dt90,
case when hour(log_time) between 0 and 5 then 1 end app_hr_025,
case when hour(log_time) between 6  and 7  then 1 end app_hr_627 ,
case when hour(log_time) between 8  and 9  then 1 end app_hr_829 ,
case when hour(log_time) between 10 and 11 then 1 end app_hr_10211,
case when hour(log_time) between 12 and 13 then 1 end app_hr_12213,
case when hour(log_time) between 14 and 15 then 1 end app_hr_14215,
case when hour(log_time) between 16 and 17 then 1 end app_hr_16217,
case when hour(log_time) between 18 and 19 then 1 end app_hr_18219,
case when hour(log_time) between 20 and 21 then 1 end app_hr_20221,
case when hour(log_time) between 22 and 23 then 1 end app_hr_22223
from snbap_dwd.dwd_user_app_pv
) app
group by app.user_id
) t_app on t_app.user_id=ub.user_id



```



>  dwd_user_pc_pv的pv数由相同sessionid的count值来表示



##### dwd与dws层与dm层得区别：

- dwd：数据明细层

  > 村的数据是一条条得数据

- dws：数据服务层

  > 会对数据进行轻度得汇总，（聚合，排名等），如统计30天用户数据面对它进行聚合一下。
  >
  > dws层一般是跨表

- dm：数据集市层：

  > 高度汇总 
  >

### hive传入参数

```sql
set hivevar:dt='2020-09-04'

使用变量
insert into table xxx partition(dt=${hivevar:dt})

通过脚本传入变量，使用下面命令
hive -hivevar dt='2020-09-04' -f xxx.sql
```

