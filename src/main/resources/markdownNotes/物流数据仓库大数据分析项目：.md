## 物流数据仓库大数据分析项目：

### 一：数据清洗

- 分析需求数据过滤

- 去重row_number()

  - 为什么要用row_number（）去重

    > distinct使用一个reduce处理，效率低下

    常用方式是row_number() + where rn= 1或者group by + max()或者dropduplicate()

#### 数据清洗思考：

1. 本地模式/集群模式 ->在项目代码中提供了两种模式， 在运行时只需要通过参数传入，local/yarn
   - 如果是本地模式，会读取csv文件，然后分析，之后保存为csv
   - 如果是集群的，就会读取hive中数据表，之后保存为hive中数据表
2. 我们参数是否要写死？
   - 在我们项目代码中，参数都是通过配置文件传入
3. 清洗规则是什么？
   - 第一个是按照时间进行数据过滤
   - 使用row_number（）对重复的数据
   - create_time和inflow_time需要进行格式化（年-月-日 时：分：秒）
4. 是否是第一次清洗?
   - 

#### 集群运行



1. 打成jar包
2. 在hive建表
3. mysql运行
4. spark运行

```shell
spark-submit --class cn.kgc.exp.preprocess.DataClean \
 --master yarn \
 --driver-memory 4G \
  --executor-memory 2g \
 --num-executors 2 \
 --executor-cores 2 \
 kgc-1.0-SNAPSHOT.jar 2 1h 2019-12-12 18:00:00 true yarn

```

![image-20200910090521361](C:%5CUsers%5Clenovo%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200910090521361.png)

### 物流数据分析业务：

#### 第一步：我们首先编写清洗表得代码

#### 第二步：我们将创建表的代码写在Hive里

#### 第三步：我们将代码打包，将其放在spark集群上运行，取清洗Hive的表

#### 第四步：将Hive的表进行数据分析处理，

##### 



#### 开始业务分析：

> 分析分类

##### 货量分析:

- **需求功能：**
  - 未来特定时间段`求出**每个运单号的预计发送时间，预计到达时间**，,用于车辆调度。

- **数据分析流程图：**

![](C:%5CUsers%5Clenovo%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200910094121971.png)

>  物流业务有几个要点

- **判断发车时间**
  - 快递的运单是分为`在途`和`非在途`的

    - `在途`

    > 如果线路是**a->A->B->C->c**，
    >
    > 如果算出A的预计到达时间，应该是
    >
    > **B的预计到达时间 =A的预计到达时间 + 卸车时间 + 装车时间** 
    >
    > 根据**装车结束的时间**， 去匹配  **车辆发车时间表** ，匹配到就对应时间发车， 匹配不到就**默认次日最早班次** 

    - `非在途`

    > 我们默认它是已经是装车成功，默认去根据  ·`当前时间匹配 发车时间表` ，确定到达下一个部门的时间。

    - `存在快递单号没有按照规定路线走货`

    > 理货员误操作把快递送错的单号不能按计划走货路径计算。
    >
    > 需匹配**外场基础信息表，重新规划运单走火路径**

计算



###### 第一步：拿到唯一id组织机构：

> 准备**组织机构信息**（有重复数据，可以在数据清洗阶段对数据去重)

###### 第二步：拿到未签收订单：

> **组织机构信息表**里**存在省份信息**，**当日达表**里存在**起点和终点是否同省**， 再通过**运单表**，拿到**当日达的运单信息**，也认为**是签收信息**，
>
> **签收表**里也是已签收信息，将**运单表**的路径排除调**签收表和当日达运单**信息后，就可以拿到**未签收信息。**



###### 第三步：运单表的信息有误：

> 因为物流中我们的线路里，我们在上一个地点假设是在库存里的，那么我们去到下一个地点，可能天色太晚了，没有匹配到对应的发车时间，**再一次记录了一次库存信息**，记录了两条库存信息，但我们只需要用到最新一条的库存信息。
>
> **解决办法：库存表的信息选取每个运单号最新的入库信息即可**

###### 第四步：路径合并问题：

> 对于物流业务来说，我们会分
>
> **大厂（集散中心）与大厂的线路**
>
> **分厂（小的物流快递点）与集散中心（物流中心）的线路**
>
> **加盟店（物流快递点）与集散中心的线路**
>
> 我们现在需要将**所有的线路**全部汇总到一张表里，变成一张外场信息表。

![image-20200910104257425](C:%5CUsers%5Clenovo%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200910104257425.png)



###### 第五步：修正车辆信息：

> 我们更关注集散中心的路线，所以对于上面路线表里，我们的集散中心的路线一定要保留，但是中间路径就不需要出现了，
>
> 对于集散中心-> xxx，和xxx->集散中心保留，至于a->b, b->A就

###### 第六步：装车任务关联：

> 需要的表：
>
> **装车任务表**，装车明细表：这两个表里放了运单号，重量，体积，出发部门，到达部门
>
> **袋信息表**：物流里由于很多小件，**会局部出发部门和到达部门一致，会将小件全部放在一个袋子里，用一个快递单号使用，但是这个父运单号里会有很多子运单号。**
>
> **运输任务表**：运输任务明细表：这两个表里放了车牌号，出发时间，到达时间，预计到达时间。
>
> **运单表**：

###### 第七步：拿到运输的时间和 创建时间   

######                                                                                            

###### 第八步：拿到运单可出发时间

> 所有的在途和非在途和未签收的运单才会需要计算运单表
>
> 关联未签收单，运单库存，中间表

`获取运单的可出发时间的计算逻辑`

- 运单号在库存：

  > 出发时间 = 当前时间

- 运单号在装车任务表：

  > 出发时间 = 当前时间

- 运单号在`在途`**车辆预计到达时间与当前时间**进行（出发时间）

  - 如果**车辆预计到达时间 大于 当前时间，**

    > 出发时间 = 预计到达时间  +  卸车时间

  - 如果**车辆预计到达时间 小于 当前时间**

    > 出发时间 = 当前时间 + 卸车时间

- 任务表中车辆到达时间不为空，并且

  到达时间+ 卸车时长 > 到达时间 + 卸车时长

##### 发车预警

##### 装车预警

##### 分拣未归